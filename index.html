<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام حلويات أبو جود</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2413/2413074.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { background-color: #f4f4f4; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        input, select { box-sizing: border-box; outline: none; width: 100%; }
        .container { max-width: 450px; margin: auto; padding: 10px; background: #fdfdfd; min-height: 100vh; }
        button:active { transform: scale(0.98); }
        .order-card { background: white; padding: 15px; margin-bottom: 12px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
        .missing-card { background: #fff8f8; padding: 12px; margin-bottom: 10px; border-radius: 12px; border-right: 8px solid #c0392b; display: flex; justify-content: space-between; align-items: center; }
        .btn-green { background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div class="container">
        <div id="noticeBoard" onclick="updateNotice()" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border: 2px dashed #856404; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; font-weight: bold; color: #856404; cursor: pointer;">
            انقر هنا لتعديل الملاحظة العامة
        </div>

        <button id="lockBtn" onclick="unlockOrders()" style="width: 100%; padding: 12px; background: #34495e; color: white; border: none; border-radius: 12px; margin-bottom: 15px; font-weight: bold; cursor: pointer;">انقر لفتح نموذج الطلبات</button>

        <div id="orderForm" style="display: none; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 25px; border-top: 8px solid #e67e22;">
            <h2 style="color: #e67e22; margin-top: 0; text-align: center; font-size: 22px;">تسجيل طلب جديد</h2>
            <input type="text" id="item" placeholder="اسم الصنف..." style="padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px;">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="number" id="amount" placeholder="الكمية" style="flex: 2; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
                <select id="unit" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
                    <option>قطعة</option><option>كيلو</option><option>لتر</option><option>بلاكة</option><option>صحن</option>
                </select>
            </div>
            <input type="text" id="details" placeholder="ملاحظات..." style="padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px; background: #fffcf0;">
            <select id="chef" style="padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 12px;">
                <option value="معاذ">الشيف معاذ</option><option value="مناف">الشيف مناف</option><option value="حسين">الشيف حسين</option>
            </select>
            <button onclick="sendToFirebase()" style="width: 100%; padding: 18px; background: #e67e22; color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer;">إرسال الطلب الآن</button>
            <button onclick="lockOrders()" style="width: 100%; background: none; color: #7f8c8d; border: none; margin-top: 10px; cursor: pointer;">إغلاق</button>
        </div>

        <h3 style="color: #2c3e50; border-right: 6px solid #e67e22; padding-right: 12px;">الطلبات المباشرة</h3>
        <div id="liveOrders"></div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

        <div style="background: #fff; padding: 20px; border-radius: 20px; border-top: 8px solid #c0392b; box-shadow: 0 10px 25px rgba(0,0,0,0.08);">
            <h3 style="color: #c0392b; margin-top: 0;">قائمة النواقص</h3>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="missingItem" placeholder="ما الذي ينقصنا؟" style="flex: 3; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
                <button onclick="sendMissingToFirebase()" style="flex: 1; background: #c0392b; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">إضافة</button>
            </div>
            <div id="missingList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        var config = {
            apiKey: "AIzaSyAMTWxOCru9c8KOFRrQiFsvJ-52D8IxrPw",
            authDomain: "abujoud95.firebaseapp.com",
            projectId: "abujoud95",
            storageBucket: "abujoud95.appspot.com",
            messagingSenderId: "85673334000",
            appId: "1:85673334000:web:707a2bfbd8e2ec6b11de35"
        };
        if (!firebase.apps.length) { firebase.initializeApp(config); }
        var db = firebase.firestore();

        var audio = document.getElementById('notifSound');
        var isAudioEnabled = false;

        window.addEventListener('touchstart', function() {
            if (!isAudioEnabled) {
                audio.play().then(() => { audio.pause(); audio.currentTime = 0; isAudioEnabled = true; });
            }
        }, { once: true });

        function playNotification() {
            if (isAudioEnabled) { audio.currentTime = 0; audio.play(); }
            if (navigator.vibrate) { navigator.vibrate([200, 100, 200]); }
        }

        window.sendToFirebase = function() {
            var it = document.getElementById('item').value.trim();
            var am = document.getElementById('amount').value.trim();
            if(!it || !am) { alert("يرجى إدخال الصنف والكمية"); return; }
            db.collection("orders").add({
                item: it, amount: am, unit: document.getElementById('unit').value,
                details: document.getElementById('details').value, chef: document.getElementById('chef').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('item').value = ""; document.getElementById('amount').value = ""; document.getElementById('details').value = "";
            });
        };

        db.collection("orders").orderBy("timestamp", "desc").onSnapshot(function(snap) {
            var cont = document.getElementById('liveOrders');
            cont.innerHTML = "";
            snap.forEach(doc => {
                var d = doc.data();
                cont.innerHTML += `<div class="order-card">
                    <div><b>${d.item}</b> - ${d.amount} ${d.unit}<br><small>الشيف: ${d.chef}</small></div>
                    <button class="btn-green" onclick="if(confirm('تم الإنجاز؟')) db.collection('orders').doc('${doc.id}').delete()">تم ✅</button>
                </div>`;
            });
        });

        window.sendMissingToFirebase = function() {
            var mi = document.getElementById('missingItem').value.trim();
            if(mi) {
                db.collection("missing").add({ name: mi, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('missingItem').value = "";
            }
        };

        db.collection("missing").orderBy("timestamp", "desc").onSnapshot(function(snap) {
            var list = document.getElementById('missingList');
            list.innerHTML = "";
            snap.forEach(doc => {
                list.innerHTML += `<div class="missing-card"><span>نقص: ${doc.data().name}</span>
                <button class="btn-green" onclick="db.collection('missing').doc('${doc.id}').delete()">تم</button></div>`;
            });
        });

        window.unlockOrders = function() {
            var pass = prompt("كلمة المرور:");
            if(pass === "1234") { 
                document.getElementById('orderForm').style.display = 'block'; 
                document.getElementById('lockBtn').style.display = 'none'; 
            } else if(pass !== null) alert("خطأ!");
        };
        
        window.lockOrders = function() { 
            document.getElementById('orderForm').style.display = 'none'; 
            document.getElementById('lockBtn').style.display = 'block'; 
        };
        
        window.updateNotice = function() {
            var nt = prompt("الملاحظة الجديدة:");
            if(nt !== null && nt.trim() !== "") db.collection("settings").doc("notice").set({ text: nt });
        };

        db.collection("settings").doc("notice").onSnapshot(doc => {
            if(doc.exists) document.getElementById('noticeBoard').innerText = doc.data().text;
        });
    </script>
</body>
</html>
